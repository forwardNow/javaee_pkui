<div class="sysmenu-container clearfix">

    <div class="sysmenu-treeContainer">
        <div class="sysmenu-treeOpe btn-group" role="group" aria-label="...">
            <button type="button" class="btn btn-success-2" title="为选择的菜单新建子菜单（未选择任何菜单时，则新建顶级菜单）"
                    onclick="createSysMenu()"><i class="fa fa-plus"></i></button>
            <button type="button" class="btn btn-info-2" title="编辑选中的菜单"
                    onclick="editSysMenu()"><i class="fa fa-edit"></i></button>
            <button type="button" class="btn btn-danger-2" title="删除选中的菜单"
                    id="deleteSysMenuButton"
                    onclick="deleteSysMenu()"><i class="fa fa-trash-o"></i></button>

            <button type="button" class="btn btn-default-2 pull-right" title="刷新"
                    onclick="refreshSysMenuTree()"><i class="fa fa-refresh"></i></button>
            <button type="button" class="btn btn-primary-2 pull-right" title="保存调整后的顺序"
                    id="saveSysMenuTreeButton"
                    onclick="saveSysMenuTree()"><i class="fa fa-save"></i></button>
        </div>
        <div id="sysMenuTree"
             data-pkui-component="menuTree"
             data-pkui-component-options='{
                "url": "__CTX__/admin/sysMenuListData",
                "dnd": true,
                "showInvisible": true
             }'></div>
    </div>

    <div class="sysmenu-menuInfo">

    </div>

</div>
<style>
    .sysmenu-container {
        height: 100%;
        margin: 0 -12px;
    }
    .sysmenu-treeOpe {
        position: absolute;
        top: 43px;
        left: 0;
        z-index: 10;
        width: 240px;
        background: #eee;
    }
    .sysmenu-treeContainer {
        overflow: auto;
        float: left;
        width: 240px;
        height: 100%;
        padding-top: 40px;
        border-right: 1px solid silver;
    }
    .sysmenu-menuInfo {
        overflow: auto;
    }

    [nodestatus="new"] > .jstree-anchor {
        color: #e8bf6a;
    }
    [nodestatus="saved"] > .jstree-anchor {
        color: #6a8759;
    }
    [nodestatus="moved"] > .jstree-anchor {
        color: #9876aa;
    }
    .dndNode > .jstree-anchor {
        color: #8b54a8;
    }
</style>
<script>
    /**
     * 创建节点时，默认的属性
     */
    createSysMenu.defaultNode = {
        icon: "fa fa-question",
        text: "请编辑并保存！"
    };
    /**
     * 保存新建的节点ID
     */
    createSysMenu.newNode = {
        // "nodeId": true
    };

    /**
     * redraw后，节点全部刷新，不能通过 $.data() 保存临时数据
     */
    sortSysMenu.modifiedNodeCache = {
        /*
        "jstree_1492756514868_3" : {
            nodestatus: "moved",
            modifiedProperties: { "menuId": 1, "treeLevel": 1, "treeParentid": 1, "orderFlag": 1 }
        }
        */
    };

    function createSysMenu () {
        var
            $ = jQuery,
            $tree = $( "#sysMenuTree" ),
            ref = $tree.jstree( true ),
            selectedNodeIds = ref.get_selected(),
            selectedNode,
            parentNodeId,
            newNodeId,
            newNodeData,
            $newNode,
            $jstreeNode
        ;

        // debugger;
        $jstreeNode = $tree.find( ".jstree-node" );

        // 有未编辑（保存）的新建菜单
        if ( createSysMenu.newNode[ selectedNodeIds[ 0 ] ] === true ) {
            layer.alert( "请先编辑（保存）已新建菜单，或将其删除。", { icon: 0 } );
            return;
        }

        newNodeData = $.extend( true, { id: "newNode_" + ( new Date() ).getTime() }, createSysMenu.defaultNode );

        // 未选择菜单，创建顶级菜单
        if( !selectedNodeIds.length ) {
            newNodeId = ref.create_node( "#", newNodeData );
        }
        // 选择的菜单
        else {
            parentNodeId = selectedNodeIds[0];
            selectedNode = ref.get_node( parentNodeId );

            // menuId 存的是 parentId（详情请查看 com.pkusoft.admin.service.impl.SysMenuServiceImpl.insertSysMenu(SysMenu sysMenu) ）
            newNodeData.menuId = selectedNode.original.menuId;
            newNodeId = ref.create_node( parentNodeId, newNodeData );
        }

        createSysMenu.newNode[ newNodeId ] = true;

        $newNode = ref.get_node( newNodeId, true );

        // 取消已被选中的
        ref.deselect_node( selectedNodeIds );

        // 让新建的node被选中
        ref.select_node( [ newNodeId ] );

        // 编辑
        editSysMenu( $jstreeNode.index( $newNode ) );
    }

    function editSysMenu( orderFlag ) {
        var
            $ = jQuery,
            $tree = $( "#sysMenuTree" ),
            $sysmenuMenuInfo,
            ref = $tree.jstree( true ),
            selectedNodeIds = ref.get_selected(),
            selectedNode,
            $selectedNode,
            model
        ;

        // debugger;

        // 如果没有被选中的
        if ( selectedNodeIds.length === 0 ) {
            layer.msg( "请选择菜单项！", { icon: 0 } );
            return;
        }

        $selectedNode = ref.get_node( selectedNodeIds[ 0 ], true );
        selectedNode = ref.get_node( selectedNodeIds[ 0 ] );

        $sysmenuMenuInfo = $( ".sysmenu-menuInfo" );

        // 新建的菜单：新增
        if ( createSysMenu.newNode[ selectedNodeIds[ 0 ] ] === true ) {

            model = $.extend( true, {}, selectedNode.original );

            if ( orderFlag != null ) {
                model.orderFlag = orderFlag;
            }

            window.PKUI.component.Template.getModelAndView(
                // viewUrl
                "__CTX__/static/desktop/tpl/system/menu/add.html",
                // modelUrl
                model,
                // callback
                function( htmlString ) {
                    $sysmenuMenuInfo.html( htmlString );
                }
            );
        }
        // 已存在的菜单：修改
        else {
            window.PKUI.component.Template.getModelAndView(
                // viewUrl
                "__CTX__/static/desktop/tpl/system/menu/edit.html",
                // modelUrl
                "__CTX__/admin/sysMenuModel?menuId=" + selectedNode.data.menuId,
                // callback
                function( htmlString ) {
                    $sysmenuMenuInfo.html( htmlString );
                }
            );
        }


    }

    function deleteSysMenu() {
        var
            $ = jQuery,
            $tree = $( "#sysMenuTree" ),
            ref = $tree.jstree( true ),
            selectedNodeIds = ref.get_selected(),
            selectedNode,
            $button
            ;

        // 如果没有被选中的
        if ( selectedNodeIds.length === 0 ) {
            layer.msg( "请选择菜单项！", { icon: 0 } );
            return;
        }
        // 新建的菜单
        if ( createSysMenu.newNode[ selectedNodeIds[ 0 ] ] === true ) {
            ref.delete_node( selectedNodeIds[ 0 ] );
            // 清除缓存
            delete createSysMenu.newNode[ selectedNodeIds[ 0 ] ];
            return;
        }

        // 已存在的菜单
        selectedNode = ref.get_node( selectedNodeIds[ 0 ] );
        $button = $( "#deleteSysMenuButton" );

        $button.isLoading( { position: "insideButton" } );

        $.ajax( {
            url: "__CTX__/admin/sysMenuDelete",
            data: {
                menuId: selectedNode.data.menuId
            }
        } ).done( function ( jsonResult ) {
            // 服务器端处理成功
            if ( jsonResult.success ) {
                // 提示
                layer.msg( '删除成功！', { icon: 1 } );

                ref.delete_node( selectedNodeIds[ 0 ] );

                // 清除缓存
                delete sortSysMenu.modifiedNodeCache[ selectedNodeIds[ 0 ] ];

                // 刷新
                //refreshSysMenuTree();
            }
            // 服务器端处理失败
            else {
                // 提示
                layer.msg( '删除失败！', { icon: 2 } );
            }
        } ).fail( function () {
            layer.msg( '网络错误！', { icon: 0 } );
        } ).always( function () {
            $button.isLoading( "hide" );
        } );


    }

    function saveSysMenuTree() {
        var
            $ = jQuery,
            // $tree = $( "#sysMenuTree" ),
            $button = $( "#saveSysMenuTreeButton" ),
            // $movedNode = $tree.find( ".jstree-node[role='treeitem'][nodestatus='moved']" ),
            data = [],

            cache = sortSysMenu.modifiedNodeCache,
            nodeId,
            modifiedProperties

        ;

        for ( nodeId in cache ) {
            if ( !cache.hasOwnProperty( nodeId ) ) {
                continue;
            }
            modifiedProperties = cache[ nodeId ].modifiedProperties;
            if ( modifiedProperties ) {
                data.push( modifiedProperties );
            }
        }
        //debugger;

        if ( data.length === 0 ) {
            return;
        }

        $button.isLoading( { position: "insideButton" } );

        $.ajax( {
            url: "__CTX__/admin/sysMenuSave",
            data: {
                sysMenuList: JSON.stringify( data )
            }
        } ).done( function ( jsonResult ) {
            // 服务器端处理成功
            if ( jsonResult.success ) {
                // 提示
                layer.msg( '修改成功！', { icon: 1 } );
                
                // 清空缓存
                sortSysMenu.modifiedNodeCache = {};

                // 刷新
                refreshSysMenuTree();
            }
            // 服务器端处理失败
            else {
                // 提示
                layer.msg( '修改失败！', { icon: 2 } );
            }
        } ).fail( function () {
            layer.msg( '网络错误！', { icon: 0 } );
        } ).always( function () {
            $button.isLoading( "hide" );
        } );
    }

    /**
     * 每进行一次拖拽，则计算每个节点的位置属性 treeLevel、treeParentid、orderFlag
     * 如果位置属性有变化，则标记其被移动（[nodestatus="moved"]），改变后的属性存储在 modifiedProperties 上
     *
     * 发送的数据（序列化后的字符串）
     *      movedSysMenuList = [
     *          { "menuId": x, "treeLevel": x, "treeParentid": x, "orderFlag": x },
     *          { "menuId": x, "treeLevel": x, "treeParentid": x, "orderFlag": x }
     *      ]
     */
    function sortSysMenu() {
        var
            $ = jQuery,
            $tree = $( "#sysMenuTree" ),
            ref = $tree.jstree( true ),
            $jstreeNode
        ;

        $jstreeNode = $tree.find( ".jstree-node[role='treeitem']" );

        // 展开所有节点（关闭的节点的children会被remove掉）
        ref.open_all();

        $jstreeNode.each( function ( index, jstreeNode ) {
            var
                nodeId = jstreeNode.id,
                node = ref.get_node( nodeId ),
                //$node = ref.get_node( nodeId, true ),
                parentNodeId = ref.get_parent( nodeId ),
                parentNode = ref.get_node( parentNodeId ),
                //$parentNode = ref.get_node( parentNodeId, true ),
                sysMenu = node.data,
                parentSysMenu = parentNode.data,

                cache = sortSysMenu.modifiedNodeCache,
                parentNodeCache = cache[ parentNodeId ],

                isMoved = false,
                modifiedProperties = { menuId: sysMenu.menuId }
            ;

            // 如果当前节点是顶级节点
            if ( parentNodeId === "#" ) {
                parentSysMenu = {
                    treeLevel: 0,
                    menuId: -1
                }
            }
            // 如果父节点也被移动了
            if ( parentNodeCache && parentNodeCache[ "nodestatus" ] === "moved" ) {
                parentSysMenu = $.extend( true, {} , parentSysMenu, parentNodeCache[ "modifiedProperties" ] );
            }

            // debugger;

            // 层级变量，父元素肯定也变了
            if ( sysMenu.treeLevel !== ( parentSysMenu.treeLevel + 1 ) ) {
                isMoved = true;
                modifiedProperties.treeLevel = parentSysMenu.treeLevel + 1;
                modifiedProperties.treeParentid = parentSysMenu.menuId;
                modifiedProperties.orderFlag = index;
            }
            else if ( sysMenu.treeParentid != parentSysMenu.menuId ) {
                isMoved = true;
                modifiedProperties.treeParentid = parentSysMenu.menuId;
                modifiedProperties.orderFlag = index;
            }
            else if ( sysMenu.orderFlag !== index ) {
                isMoved = true;
                modifiedProperties.orderFlag = index;
            }

            if ( isMoved ) {
                sortSysMenu.modifiedNodeCache[ nodeId ] = {
                    nodestatus: "moved",
                    modifiedProperties: modifiedProperties
                }
            }
        } );


    }

    /**
     * 销毁 jstree
     * 删除 MenuTree引用 和 isrendered标志
     * 清空 右侧容器（调用 jquery.html()方法后，会自动渲染）
     */
    function refreshSysMenuTree() {
        var
            $ = jQuery,
            $tree = $( "#sysMenuTree" ),
            $sysmenuMenuInfo = $( ".sysmenu-menuInfo" ),
            ref = $tree.jstree( true )
        ;
        // 销毁 jstree
        ref.destroy();

        // 删除 MenuTree引用 和 isrendered标志
        $tree
            .data( "pkui.menutree", null )
            .removeAttr( "isrendered" ) ;

        // 清空 右侧容器（调用 jquery.html()方法后，会自动渲染）
        $sysmenuMenuInfo.html( "" );

        regSysMenuSelectNodeEvent();

    }

    function regSysMenuSelectNodeEvent() {
        var
            $ = jQuery,
            $sysmenuMenuInfo = $( ".sysmenu-menuInfo" )
            ;
        $( "#sysMenuTree" ).on( "select_node.jstree", function( event, selected ) {
            var
                //$tree = $( "#sysMenuTree" ),
                //ref = $tree.jstree( true ),
                sysMenu = selected.node.data,
                selectedNodeId = selected.node.id[0]
                ;
            debugger;
            // 新建 但未保存的，则调用编辑
            if ( createSysMenu.newNode[ selectedNodeId ] === true ) {
                //layer.msg( "未保存的新建菜单不能查看详情页", { icon: 0 } );
                editSysMenu();
                return;
            }

            window.PKUI.component.Template.getModelAndView(
                // viewUrl
                "__CTX__/static/desktop/tpl/system/menu/detail.html",
                // modelUrl
                sysMenu,
                // callback
                function( htmlString ) {
                    $sysmenuMenuInfo.html( htmlString );
                }
            );
        } );
    }

    regSysMenuSelectNodeEvent();

    $( document ).on( "dnd_stop.vakata", function ( event, relatedData ) {
        /*var
            rel = relatedData.data.origin,
            dndNodeIds = relatedData.data.nodes,
            $dndNode = rel.get_node( dndNodeIds[ 0 ], true ),
            // anchor
            $dndElement = $( relatedData.element )
        ;*/
        // debugger;
        //$dndNode.addClass( "dndNode" );
        sortSysMenu();
    } );


</script>