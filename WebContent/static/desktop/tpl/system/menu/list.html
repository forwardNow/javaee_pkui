<div class="sysmenu-container clearfix">

    <div class="sysmenu-treeContainer">
        <div class="sysmenu-treeOpe btn-group" role="group" aria-label="...">
            <button type="button" class="btn btn-success-2" title="为选择的菜单新建子菜单（未选择任何菜单时，则新建顶级菜单）"
                    onclick="createSysMenu()"><i class="fa fa-plus"></i></button>
            <button type="button" class="btn btn-info-2" title="编辑选中的菜单"
                    onclick="editSysMenu()"><i class="fa fa-edit"></i></button>
            <button type="button" class="btn btn-danger-2" title="删除选中的菜单"
                    onclick="deleteSysMenu()"><i class="fa fa-trash-o"></i></button>

            <button type="button" class="btn btn-default-2 pull-right" title="刷新"><i class="fa fa-refresh"></i></button>
            <button type="button" class="btn btn-primary-2 pull-right" title="保存调整后的顺序"><i class="fa fa-save"></i></button>
        </div>
        <div id="sysMenuTree"
             data-pkui-component="menuTree"
             data-pkui-component-options='{
                "url": "__CTX__/admin/sysMenuListData",
                "dnd": true,
                "showInvisible": true
             }'></div>
    </div>

    <div class="sysmenu-menuInfo">

    </div>

</div>
<style>
    .sysmenu-container {
        /*height: 100%;*/
        margin: 0 -12px;
    }
    .sysmenu-treeOpe {
        position: absolute;
        top: 43px;
        left: 0;
        z-index: 10;
        width: 240px;
        background: #eee;
    }
    .sysmenu-treeContainer {
        overflow: auto;
        float: left;
        width: 240px;
        height: 100%;
        padding-top: 40px;
        border-right: 1px solid silver;
    }
    .sysmenu-menuInfo {
        overflow: auto;
    }
</style>
<script>
    createSysMenu.defaultNode = {
        icon: "fa fa-question",
        text: "请编辑并保存！",
        li_attr: {
            /**
             * "new"：新建的节点
             * "saved"：已保存，其sysMenu 存在 $li.data( "sysMenu" )
             */

            "newnodestatus": "new"
        }
    };
    function createSysMenu () {
        var
            $ = jQuery,
            $tree = $( "#sysMenuTree" ),
            ref = $tree.jstree( true ),
            selectedNodeIds = ref.get_selected(),
            selectedNode,
            $selectedNode,
            parentNodeId,
            newNodeId,
            newNodeData,
            $unsavedNode,
            $prevNode
        ;
        debugger;
        // 是否有未编辑（保存）的新建菜单
        $unsavedNode = $tree.find( ".jstree-node" ).filter( '[createnode="new"]' );

        if ( $unsavedNode.size() > 0 ) {
            layer.alert( "请先编辑（保存）已新建菜单，或将其删除。", { icon: 0 } );
            return;
        }

        newNodeData = $.extend( true, {}, createSysMenu.defaultNode );

        // 未选择菜单，创建顶级菜单
        if( !selectedNodeIds.length ) {
            newNodeData.treeLevel = 0;
            newNodeData.treeParentid = null;
            newNodeId = ref.create_node( "#", newNodeData );
        }
        // 选择的菜单
        else {
            parentNodeId = selectedNodeIds[0];
            selectedNode = ref.get_node( parentNodeId );

            $selectedNode = ref.get_node( parentNodeId, true );
            $prevNode = $selectedNode.find( ".jstree-node" ).last();


            //newNodeData.treeLevel = selectedNode.original.treeLevel + 1;
            //newNodeData.treeParentid = selectedNode.original.menuId;
            newNodeData.menuId = selectedNode.original.menuId;
            newNodeData.orderFlag = parseInt( $prevNode.attr( "orderflag" ) || "10" ) + 1;
            newNodeId = ref.create_node( parentNodeId, newNodeData );
        }

        // 取消已被选中的
        ref.deselect_node( selectedNodeIds );

        // 让新建的node被选中
        ref.select_node( [ newNodeId ] );

        // 编辑
        editSysMenu();
    }

    function editSysMenu() {
        var
            $ = jQuery,
            $tree = $( "#sysMenuTree" ),
            $sysmenuMenuInfo,
            ref = $tree.jstree( true ),
            selectedNodeIds = ref.get_selected(),
            selectedNode,
            $selectedNode
        ;

        debugger;

        // 如果没有被选中的
        if ( selectedNodeIds.length === 0 ) {
            layer.msg( "请选择菜单项！", { icon: 0 } );
            return;
        }

        $selectedNode = ref.get_node( selectedNodeIds[ 0 ], true );
        selectedNode = ref.get_node( selectedNodeIds[ 0 ] );

        $sysmenuMenuInfo = $( ".sysmenu-menuInfo" );

        // 新建的菜单
        if ( $selectedNode.attr( "newnodestatus" ) === "new" ) {
            window.PKUI.component.Template.getModelAndView(
                // viewUrl
                "__CTX__/static/desktop/tpl/system/menu/add.html",
                // modelUrl
                selectedNode.original,
                // callback
                function( htmlString ) {
                    $sysmenuMenuInfo.html( htmlString );
                }
            );
        }
        // 已存在的菜单
        else {
            window.PKUI.component.Template.getModelAndView(
                // viewUrl
                "__CTX__/static/desktop/tpl/system/menu/edit.html",
                // modelUrl
                "__CTX__/admin/sysMenuModel?menuId=" + selectedNode.data.menuId,
                // callback
                function( htmlString ) {
                    $sysmenuMenuInfo.html( htmlString );
                }
            );
        }


    }

    function deleteSysMenu() {

        // 新建的菜单

        // 已存在的菜单
    }


    +function() {
        var
            $ = jQuery,
            $sysmenuMenuInfo = $( ".sysmenu-menuInfo" ),
            $tree = $( "#sysMenuTree" )
        ;
        jQuery( "#sysMenuTree" ).on( "select_node.jstree", function( event, selected ) {
            var
                ref = $tree.jstree( true ),
                sysMenu = selected.node.data,
                $selectedNode = ref.get_node( selected.node.id, true ),
                newnodestatus = $selectedNode.attr( "newnodestatus" )
            ;
            // 新建 但未保存的，直接返回
            if ( newnodestatus === "new" ) {
                //layer.msg( "未保存的新建菜单不能查看详情页", { icon: 0 } );
                return;
            }
            // 新建 且已保存，
            else if ( newnodestatus === "saved" ) {
                sysMenu = $selectedNode.data( "sysMenu" );
            }

            window.PKUI.component.Template.getModelAndView(
                // viewUrl
                "__CTX__/static/desktop/tpl/system/menu/detail.html",
                // modelUrl
                sysMenu,
                // callback
                function( htmlString ) {
                    $sysmenuMenuInfo.html( htmlString );
                }
            );
        } );

    } ();
</script>